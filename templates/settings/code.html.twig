{% extends 'base.html.twig' %}

{% block title %}コード設定{% endblock %}

{% block body %}
<div class="container py-3">
    <div class="d-flex align-items-center justify-content-between mb-3">
        <div>
            <h1 class="h4 mb-1">コード設定</h1>
            <p class="text-muted small mb-0">codeテーブルの内容を保守します。</p>
        </div>
        <div class="d-flex gap-2">
            <a class="btn btn-outline-secondary btn-sm" href="{{ path('app_settings_index') }}">設定一覧へ</a>
            <a class="btn btn-outline-secondary btn-sm" href="{{ path('app_home') }}">ホームへ</a>
        </div>
    </div>

    <div class="card shadow-sm mb-3">
        <div class="card-header bg-white">
            <strong class="small">新規追加</strong>
        </div>
        <div class="card-body py-2">
            <form class="row g-2 align-items-end" method="post" action="{{ path('app_settings_code_create') }}">
                <input type="hidden" name="_token" value="{{ csrf_token('code_create') }}">
                <div class="col-md-3">
                    <label class="form-label small mb-1" for="code-type">種別</label>
                    <select class="form-select form-select-sm" id="code-type" name="type" required>
                        <option value="">選択してください</option>
                        {% for option in typeOptions %}
                            <option value="{{ option }}">{{ option }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-3">
                    <label class="form-label small mb-1" for="code-identifier">識別子</label>
                    <input type="text" class="form-control form-control-sm" id="code-identifier" name="identifier" required>
                </div>
                <div class="col-md-2">
                    <label class="form-label small mb-1" for="code-value">値</label>
                    <input type="text" class="form-control form-control-sm" id="code-value" name="value" required maxlength="32">
                </div>
                <div class="col-md-3">
                    <label class="form-label small mb-1" for="code-displayname">表示名</label>
                    <input type="text" class="form-control form-control-sm" id="code-displayname" name="displayname">
                </div>
                <div class="col-md-1">
                    <label class="form-label small mb-1" for="code-display-order">表示順</label>
                    <input type="number" class="form-control form-control-sm" id="code-display-order" name="display_order" value="0">
                </div>
                <div class="col-md-2">
                    <button type="submit" class="btn btn-primary btn-sm w-100">追加</button>
                </div>
            </form>
        </div>
    </div>

    <div class="card shadow-sm">
        <div class="card-header bg-white">
            <strong>一覧</strong>
        </div>
        <div class="card-body p-0">
            {% if codes is empty %}
                <div class="p-3 small text-muted">登録データがありません。</div>
            {% else %}
                <div id="code-grid"></div>
                <form id="code-update-form" method="post" action="{{ path('app_settings_code_update') }}" class="d-none">
                    <input type="hidden" name="_token" value="{{ csrf_token('code_update') }}">
                    <input type="hidden" name="type">
                    <input type="hidden" name="identifier">
                    <input type="hidden" name="new_identifier">
                    <input type="hidden" name="value">
                    <input type="hidden" name="displayname">
                    <input type="hidden" name="display_order">
                </form>
                <form id="code-delete-form" method="post" action="{{ path('app_settings_code_delete') }}" class="d-none">
                    <input type="hidden" name="_token" value="{{ csrf_token('code_delete') }}">
                    <input type="hidden" name="type">
                    <input type="hidden" name="identifier">
                </form>
                <div class="modal fade" id="code-edit-modal" tabindex="-1" aria-hidden="true">
                    <div class="modal-dialog modal-dialog-centered">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">コード編集</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                            </div>
                            <div class="modal-body">
                                <div class="mb-3">
                                    <label class="form-label small" for="code-edit-identifier">識別子</label>
                                    <input type="text" class="form-control form-control-sm" id="code-edit-identifier" required>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label small" for="code-edit-value">値</label>
                                    <input type="text" class="form-control form-control-sm" id="code-edit-value" maxlength="32" required>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label small" for="code-edit-displayname">表示名</label>
                                    <input type="text" class="form-control form-control-sm" id="code-edit-displayname">
                                </div>
                                <div class="mb-3">
                                    <label class="form-label small" for="code-edit-displayorder">表示順</label>
                                    <input type="number" class="form-control form-control-sm" id="code-edit-displayorder" min="0" step="1">
                                </div>
                                <div class="small text-muted" id="code-edit-meta"></div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-outline-secondary btn-sm" data-bs-dismiss="modal">キャンセル</button>
                                <button type="button" class="btn btn-primary btn-sm" id="code-edit-save">保存</button>
                            </div>
                        </div>
                    </div>
                </div>
            {% endif %}
        </div>
    </div>
</div>

{% if codes is not empty %}
    <script>
        const gridData = {{ gridData|json_encode|raw }};
        const parentElement = document.getElementById('code-grid');
        const updateForm = document.getElementById('code-update-form');
        const deleteForm = document.getElementById('code-delete-form');

        if (parentElement) {
            parentElement.style.width = '100%';
            parentElement.style.height = '480px';
            parentElement.style.border = '1px solid #ddd';

            const records = (gridData || []).map(r => Object.assign({ __update: '更', __delete: '削' }, r));

        const header = [
            { field: '__update', caption: '', width: 44, style: { textAlign: 'center', bgColor: '#eef3ff', color: '#0d6efd' } },
            { field: '__delete', caption: '', width: 44, style: { textAlign: 'center', bgColor: '#fff0f0', color: '#dc3545' } },
            { field: 'type', caption: '種別', width: 200 },
            { field: 'identifier', caption: '識別子', width: 200 },
            { field: 'value', caption: '値', width: 160 },
            { field: 'displayname', caption: '表示名', width: 220 },
            { field: 'displayOrder', caption: '表示順', width: 80 },
            { field: 'updatedAt', caption: '更新日時', width: 140 },
        ];

            const grid = new cheetahGrid.ListGrid({
                parentElement: parentElement,
                header: header,
                records: records,
                frozenColCount: 2,
                defaultRowHeight: 28,
                headerRowHeight: 28,
                theme: {
                    defaultStyle: {
                        font: '12px "Noto Sans JP", "Hiragino Kaku Gothic ProN", Meiryo, sans-serif',
                    },
                },
            });

        const typeOptions = {{ typeOptions|default([])|json_encode|raw }};

        const editModalEl = document.getElementById('code-edit-modal');
        let editModal = null;
        const editIdentifierInput = document.getElementById('code-edit-identifier');
        const editValueInput = document.getElementById('code-edit-value');
        const editDisplaynameInput = document.getElementById('code-edit-displayname');
        const editDisplayOrderInput = document.getElementById('code-edit-displayorder');
        const editMeta = document.getElementById('code-edit-meta');
        const editSave = document.getElementById('code-edit-save');
        let editingRecord = null;

        function submitUpdate(record) {
            if (!updateForm || !editModalEl) return;
            const currentType = record.type ?? '';
            if (typeOptions.length > 0 && !typeOptions.includes(currentType)) {
                alert('種別が不正です。');
                return;
            }
            if (!editModal && window.bootstrap) {
                editModal = new window.bootstrap.Modal(editModalEl);
            }
            if (!editModal) {
                alert('画面初期化中です。少し待ってから再度お試しください。');
                return;
            }
            editingRecord = record;
            editIdentifierInput.value = record.identifier ?? '';
            editValueInput.value = record.value ?? '';
            editDisplaynameInput.value = record.displayname ?? '';
            editDisplayOrderInput.value = String(record.displayOrder ?? 0);
            editMeta.textContent = `${record.type ?? ''} / ${record.identifier ?? ''}`;
            editModal.show();
        }

        if (editSave) {
            editSave.addEventListener('click', () => {
                if (!editingRecord || !updateForm) return;
                const newIdentifier = editIdentifierInput.value ?? '';
                const newValue = editValueInput.value ?? '';
                if (String(newIdentifier).trim() === '') {
                    alert('識別子は必須です。');
                    return;
                }
                if (String(newValue).trim() === '') {
                    alert('値は必須です。');
                    return;
                }
                if (String(newValue).length > 32) {
                    alert('値は32文字以内で入力してください。');
                    return;
                }
                const newDisplayname = editDisplaynameInput.value ?? '';
                const newDisplayOrder = editDisplayOrderInput.value ?? '0';

                updateForm.querySelector('input[name="type"]').value = editingRecord.type || '';
                updateForm.querySelector('input[name="identifier"]').value = editingRecord.identifier || '';
                updateForm.querySelector('input[name="new_identifier"]').value = String(newIdentifier);
                updateForm.querySelector('input[name="value"]').value = String(newValue);
                updateForm.querySelector('input[name="displayname"]').value = String(newDisplayname);
                updateForm.querySelector('input[name="display_order"]').value = String(newDisplayOrder);
                updateForm.submit();
            });
        }

            function submitDelete(record) {
                if (!deleteForm) return;
                if (!window.confirm('削除しますか？')) return;
                deleteForm.querySelector('input[name="type"]').value = record.type || '';
                deleteForm.querySelector('input[name="identifier"]').value = record.identifier || '';
                deleteForm.submit();
            }

            grid.listen('click_cell', function(args) {
                if (!args) return;
                if (args.col !== 0 && args.col !== 1) return;

                let rec = args.record || null;
                if (!rec && grid.records && typeof args.row === 'number') {
                    const idx = Math.max(0, args.row - 1);
                    rec = grid.records[idx] || null;
                }
                if (!rec) return;

                if (args.col === 0) {
                    submitUpdate(rec);
                } else {
                    submitDelete(rec);
                }
            });

            grid.listen('mousemove_cell', function(args) {
                if (!args) return;
                parentElement.style.cursor = (args.col === 0 || args.col === 1) ? 'pointer' : '';
            });
            grid.listen('mouseleave_grid', function() {
                parentElement.style.cursor = '';
            });
        }
    </script>
{% endif %}
{% endblock %}
