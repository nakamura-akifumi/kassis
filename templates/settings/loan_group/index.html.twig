{% extends 'base.html.twig' %}

{% block title %}貸出グループ設定{% endblock %}

{% block body %}
<div class="container py-3">
    <div class="d-flex align-items-center justify-content-between mb-3">
        <div>
            <h1 class="h4 mb-1">貸出グループ設定</h1>
            <p class="text-muted small mb-0">分類1を貸出グループでまとめて管理します。</p>
        </div>
        <div class="d-flex gap-2">
            <a class="btn btn-outline-secondary btn-sm" href="{{ path('app_settings_index') }}">設定一覧へ</a>
            <a class="btn btn-outline-secondary btn-sm" href="{{ path('app_home') }}">ホームへ</a>
        </div>
    </div>

    <div class="card shadow-sm mb-3">
        <div class="card-header bg-white d-flex align-items-center justify-content-between">
            <strong class="small">新規追加</strong>
            <form method="post" action="{{ path('app_settings_loan_group_create_from_type1') }}">
                <input type="hidden" name="_token" value="{{ csrf_token('loan_group_create_from_type1') }}">
                <button type="submit" class="btn btn-outline-secondary btn-sm">分類1から一括作成</button>
            </form>
        </div>
        <div class="card-body py-2">
            <form class="row g-2 align-items-start" method="post" action="{{ path('app_settings_loan_group_create') }}">
                <input type="hidden" name="_token" value="{{ csrf_token('loan_group_create') }}">
                <div class="col-md-4">
                    <label class="form-label small mb-1" for="loan-group-name">貸出グループ名</label>
                    <input type="text" class="form-control form-control-sm" id="loan-group-name" name="name" required>
                </div>
                <div class="col-md-6">
                    <label class="form-label small mb-1" for="loan-group-type1">分類1</label>
                    <select class="form-select form-select-sm" id="loan-group-type1" name="type1_identifiers[]" multiple size="6">
                        {% for identifier, label in type1Options %}
                            <option value="{{ identifier }}">{{ label }}</option>
                        {% endfor %}
                    </select>
                    <div class="form-text">複数選択可能です。</div>
                </div>
                <div class="col-md-2">
                    <button type="submit" class="btn btn-primary btn-sm w-50">追加</button>
                </div>
            </form>
        </div>
    </div>

    <div class="card shadow-sm">
        <div class="card-header bg-white">
            <strong>一覧</strong>
        </div>
        <div class="card-body p-0">
            {% if groups is empty %}
                <div class="p-3 small text-muted">登録データがありません。</div>
            {% else %}
                <div class="table-responsive">
                    <table class="table table-sm table-striped align-middle mb-0">
                        <thead>
                            <tr>
                                <th>貸出グループ名</th>
                                <th>分類1</th>
                                <th class="text-end">操作</th>
                            </tr>
                        </thead>
                        {% set allGroupLabel = 'Model.LoanGroup.values.all_group_members_identifier'|trans %}
                        <tbody>
                            {% for group in groups %}
                                {% set isAllGroup = group.type1Mappings is empty and group.name == allGroupLabel %}
                                <tr>
                                    <td>{{ group.name }}</td>
                                    <td>
                                        {% if group.type1Mappings is empty %}
                                            <span class="text-muted small">未設定</span>
                                        {% else %}
                                            {% for mapping in group.type1Mappings %}
                                                {% set label = type1Options[mapping.type1Identifier] ?? mapping.type1Identifier %}
                                                <span class="badge text-bg-light border me-1 mb-1">{{ label }}</span>
                                            {% endfor %}
                                        {% endif %}
                                    </td>
                                    <td class="text-end">
                                        {% if not isAllGroup %}
                                            <a class="btn btn-outline-primary btn-sm" href="{{ path('app_settings_loan_group_edit', {id: group.id}) }}">編集</a>
                                            <form method="post" action="{{ path('app_settings_loan_group_delete', {id: group.id}) }}" class="d-inline">
                                                <input type="hidden" name="_token" value="{{ csrf_token('loan_group_delete_' ~ group.id) }}">
                                                <button type="submit" class="btn btn-outline-danger btn-sm" onclick="return confirm('削除しますか？')">削除</button>
                                            </form>
                                        {% endif %}
                                    </td>
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}
